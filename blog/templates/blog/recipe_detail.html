{% extends 'base.html' %}
{% load static %}
{% block content %}

{% load crispy_forms_tags %}

<div class="masthead">
  <div class="container">
    <div class="row g-0">
      <div class="col-md-6 masthead-text">
        <div class="d-none d-md-block col-md-6 masthead-image">
          {% if "placeholder" in recipe.recipe_image.url %}
          <img src="{% static 'images/recipe-placeholder.jpg' %}" class="recipe-image" alt="placeholder image">
          {% else %}
          <img src="{{ recipe.recipe_image.url }}" class=" recipe-image" alt="recipe_name">
          {% endif %}
        </div>

        <h1 class="recipe-title">{{ recipe.recipe_name }}</h1>
        <p class="recipe-subtitle"><i class="fa-solid fa-spoon"></i> {{ recipe.author }} | <small>{{ recipe.created_on | date:"F j, Y" }}</small></p>
      </div>
    </div>
  </div>
</div>

<!-- Add a print button, Edit and Delete buttons inline -->
<div class="container">
  <div class="row">
    <div class="col-12 d-flex justify-content-end">
      <button onclick="window.print()" class="btn btn-primary mb-3">Print Recipe</button>
      {% if request.user == recipe.author %}
      <a href="{% url 'blog:edit_recipe' slug=recipe.slug %}" class="btn btn-warning btn-sm mx-2">Edit</a>
      <a href="{% url 'blog:delete_recipe' slug=recipe.slug %}" class="btn btn-danger btn-sm"
        onclick="return confirm('Are you sure you want to delete this recipe?')">Delete</a>
      {% endif %}
    </div>
  </div>

  <!-- Prep time, cook time, and total time -->
  <div class="row mb-3">
    <div class="col-12">
      <p class="font-weight-bold d-flex justify-content-start">
        <span class="me-4">Prep Time :{{ recipe.prep_time }} mins</span>
        <span class="me-4">Cook Time :{{ recipe.cook_time }} mins</span>
        <span>Total Time :{{ recipe.total_time }} mins</span>
      </p>
    </div>
  </div>


  <!-- Display average rating (stars) -->
  <div class="mt-4">
    
    <div class="star-rating">
      {% for i in stars %}
        {% if i <= avg_rating|floatformat:0|add:0 %}
          <span class="star filled">★</span>
        {% elif i <= avg_rating|add:0.5|floatformat:0|add:0 %}
          <span class="star half-filled">★</span>
        {% else %}
          <span class="star">★</span>
        {% endif %}
      {% endfor %}
    </div>
    <span>{{ avg_rating|floatformat:1 }} </span>
  </div>

  <div class="row">
    <div class="col card mb-4 mt-3 left top">
      <div class="card-body">
        <p class="card-text">
          <hr />
        <article>{{ recipe.ingredients | safe }}</article>
        <hr />
        <article> {{ recipe.instructions | safe }} </article>
        </p>
      </div>
      
    </div>
  </div>
  <div class="row">
    <div class="col-12">
        <strong class="text-secondary">
            <i class="far fa-comments"></i> {{ rating_count }}
        </strong>
    </div>
    <div class="col-12">
      <hr>
    </div>
  </div>
  <!-- Displaying Ratings -->
  <div class="row">
    <div class="col-md-8 card mb-4  mt-3">
      <h3>Reviews:</h3>
      <div class="card-body">
        {% for review in reviews %}
        <div class="p-2 reviews
          {% if not review.author == user %}
          ">
          <p class="font-weight-bold">
            {{ review.user.username }}
            </span> wrote:
          </p>
          <div id="review{{ review.id }}">
            {{ review.review | linebreaks }}
          </div>
          <span class="font-weight-normal">
            {{ review.created_at|date:"Y-m-d" }}
            {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    
    {% if user.is_authenticated %}
    {% if user_rating %}
        <div class="alert alert-info">
            You've already rated this recipe. 
        </div>
    {% else %}
        <h4>Write a review:</h4>
        <form method="POST">
            {% csrf_token %}
            <div class="star-rating">
                <input type="radio" name="rating" id="rating5" value="5" required><label for="rating5" title="5"></label>
                <input type="radio" name="rating" id="rating4" value="4" required><label for="rating4" title="4"></label>
                <input type="radio" name="rating" id="rating3" value="3" required><label for="rating3" title="3"></label>
                <input type="radio" name="rating" id="rating2" value="2" required><label for="rating2" title="2"></label>
                <input type="radio" name="rating" id="rating1" value="1" required><label for="rating1" title="1"></label>
            </div>
            <br>
            Review:
            <br>
            <textarea name="review" rows="3" cols="100"></textarea>
            <br>
            <button type="submit" class="btn btn-primary">Submit Review</button>
        </form>
    {% endif %}
{% else %}
    <p>Please <a href="{% url 'accounts:signin' %}">log in</a> to rate this recipe.</p>
{% endif %}

<!-- Display messages -->
<!-- {% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %} -->
    

    {% endblock content %}